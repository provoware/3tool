#!/usr/bin/env bash
# 0000-testall: Installiert Prueftools, zeigt Versionen, fuehrt Lint, Tests und Format aus.

set -euo pipefail
IFS=$'\n\t'

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
if [ "$(basename "$SCRIPT_DIR")" = "scripts" ]; then
  PROJECT_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)
else
  PROJECT_ROOT="$SCRIPT_DIR"
fi

LOG_DIR="${LOG_DIR:-$PROJECT_ROOT/var/log}"
LOG_FILE="$LOG_DIR/0000-testall.log"
VENV_DIR="${VENV_DIR:-$PROJECT_ROOT/.venv}"
DEBUG_MODE=0

usage() {
  cat <<'USAGE'
Nutzung (Usage): 0000-testall [--debug] [--no-format] [--no-tests]

Optionen:
  --debug      Debug-Modus (Fehlersuche) aktivieren.
  --no-format  Formatierung (Code-Format) ueberspringen.
  --no-tests   Tests (automatische Pruefung) ueberspringen.
USAGE
}

log_info() {
  printf "[%s] %s\n" "$(date +'%Y-%m-%d %H:%M:%S')" "$1"
}

log_warn() {
  printf "[%s] WARNUNG: %s\n" "$(date +'%Y-%m-%d %H:%M:%S')" "$1"
}

log_error() {
  printf "[%s] FEHLER: %s\n" "$(date +'%Y-%m-%d %H:%M:%S')" "$1" >&2
}

NO_FORMAT=0
NO_TESTS=0

for arg in "$@"; do
  case "$arg" in
    --debug)
      DEBUG_MODE=1
      ;;
    --no-format)
      NO_FORMAT=1
      ;;
    --no-tests)
      NO_TESTS=1
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      log_error "Unbekannte Option: $arg"
      usage
      exit 1
      ;;
  esac
done

if [ "$DEBUG_MODE" -eq 1 ]; then
  set -x
fi

mkdir -p "$LOG_DIR"
exec > >(tee -a "$LOG_FILE") 2>&1

log_info "üßô Starte 0000-testall im Projektordner: $PROJECT_ROOT"

if [ ! -w "$PROJECT_ROOT" ]; then
  log_error "Projektordner ist nicht beschreibbar. Bitte Rechte pruefen."
  exit 1
fi

cd "$PROJECT_ROOT"

if ! command -v python3 >/dev/null 2>&1; then
  log_error "python3 fehlt. Bitte Python 3.10+ installieren."
  exit 1
fi

if [ ! -d "$VENV_DIR" ]; then
  log_info "üîß Virtuelle Umgebung (venv) wird erstellt: $VENV_DIR"
  python3 -m venv "$VENV_DIR"
fi

# shellcheck disable=SC1091
source "$VENV_DIR/bin/activate"

log_info "üì¶ Abhaengigkeiten (Dependencies) werden installiert/aktualisiert..."
python -m pip install --upgrade pip > /dev/null

if [ -f "requirements.txt" ]; then
  python -m pip install -r requirements.txt
else
  log_warn "requirements.txt nicht gefunden. Grundpakete werden uebersprungen."
fi

if [ -f "requirements-dev.txt" ]; then
  python -m pip install -r requirements-dev.txt
else
  log_warn "requirements-dev.txt nicht gefunden. Prueftools werden einzeln installiert."
  python -m pip install flake8 mypy ruff black isort autoflake pytest
fi

log_info "\nüîç Versionen der Prueftools:"
python -m flake8 --version || log_warn "flake8 nicht verfuegbar."
python -m mypy --version || log_warn "mypy nicht verfuegbar."
python -m ruff --version || log_warn "ruff nicht verfuegbar."
python -m black --version || log_warn "black nicht verfuegbar."
python -m isort --version || log_warn "isort nicht verfuegbar."
python -m autoflake --version || log_warn "autoflake nicht verfuegbar."
python -m pytest --version || log_warn "pytest nicht verfuegbar."

log_info "\nüîé Starte Validierung (Linting)..."
python -m flake8 .
python -m mypy .
python -m ruff check .

if [ "$NO_TESTS" -eq 0 ]; then
  if [ -d "tests" ]; then
    log_info "\nüß™ Starte Tests (pytest)..."
    python -m pytest
  else
    log_warn "tests/ nicht gefunden. Tests werden uebersprungen."
  fi
else
  log_warn "Tests wurden per --no-tests uebersprungen."
fi

if [ "$NO_FORMAT" -eq 0 ]; then
  log_info "\n‚ú® Wende Auto-Fixes (Formatierung) an..."
  python -m black .
  python -m isort .
  python -m autoflake --in-place --remove-unused-variables -r .
else
  log_warn "Formatierung wurde per --no-format uebersprungen."
fi

log_info "\n‚úÖ Alle Pruefungen und Fixes abgeschlossen. Logdatei: $LOG_FILE"
